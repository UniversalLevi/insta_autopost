{% extends "layout.html" %}

{% block title %}Posting{% endblock %}
{% block page_title %}New Post{% endblock %}

{% block content %}
<div class="card">
    <div class="form-group">
        <label class="form-label">Select Accounts</label>
        <div id="account-selector" class="grid grid-3">
            <div class="text-muted">Loading accounts...</div>
        </div>
        <div style="margin-top: 0.75rem; padding: 1rem; background: var(--info-light); border-radius: var(--radius-sm); border-left: 4px solid var(--info); border: 1px solid rgba(59, 130, 246, 0.3);">
            <a href="/auth/meta/login" class="btn btn-secondary" style="text-decoration: none; margin-bottom: 0.5rem;">
                <span>üîó</span> Connect with Meta
            </a>
            <div class="text-sm text-muted" style="margin-top: 0.5rem;">Connect your Instagram via Meta to post, schedule, and use all features on your account.</div>
        </div>
    </div>

    <div class="form-group">
        <label class="form-label">Media Type</label>
        <div class="flex gap-2" id="media-type-buttons">
            <button type="button" class="btn btn-primary" data-type="image" onclick="setMediaType('image')">Image</button>
            <button type="button" class="btn btn-secondary" data-type="video" onclick="setMediaType('video')">Video</button>
            <button type="button" class="btn btn-secondary" data-type="reels" onclick="setMediaType('reels')">Reels</button>
            <button type="button" class="btn btn-secondary" data-type="carousel" onclick="setMediaType('carousel')">Carousel</button>
        </div>
        <div id="video-reels-note" class="text-sm text-muted" style="display: none; margin-top: 6px; padding: 8px; background: var(--success-light); border-radius: 4px; border-left: 3px solid var(--success); border: 1px solid rgba(16, 185, 129, 0.3); color: #6EE7B7;">
            <strong>Video & Reels:</strong> Same as posts. Upload from your device below ‚Äî files are stored on your server and published to Instagram. Set <code>BASE_URL</code> to your public URL in production.
        </div>
        <input type="hidden" id="media-type" value="image">
    </div>

    <div class="form-group">
        <label class="form-label flex items-center gap-2" style="cursor: pointer;">
            <input type="checkbox" id="post-by-url-toggle" onchange="togglePostByUrl()">
            Post by URL (optional)
        </label>
        <div class="text-sm text-muted">Or paste a public HTTPS URL instead of uploading. For images, video, and reels: uploading from your device is the same flow ‚Äî file goes to your server, then to Instagram.</div>
    </div>

    <div id="post-by-url-section" class="form-group hidden">
        <label class="form-label">Media URLs</label>
        <textarea id="media-urls" class="form-control" rows="3" placeholder="https://yourdomain.com/uploads/video.mp4&#10;Or any public HTTPS URL"></textarea>
        <div class="text-sm text-muted">One URL per line. Image: .jpg .png .webp. Video: .mp4 .mov</div>
        <div id="video-url-warning" class="text-sm" style="display: none; margin-top: 8px; padding: 8px; background: var(--warning-light); border-radius: 4px; border-left: 3px solid var(--warning); border: 1px solid rgba(245, 158, 11, 0.3); color: #FCD34D;">
            Use a stable public HTTPS URL. Prefer &quot;Upload Media&quot; above so the file is stored on your server.
        </div>
    </div>

    <div id="upload-section" class="form-group">
        <label class="form-label">Upload Media</label>
        <div id="drop-zone" class="upload-zone">
            <div class="upload-content">
                <span class="icon" style="font-size: 2rem;">‚òÅÔ∏è</span>
                <p>Drag & drop files here or click to select</p>
                <div class="text-sm text-muted">Supports JPG, PNG, MP4, MOV</div>
            </div>
            <input type="file" id="file-input" class="hidden" multiple accept="image/*,video/*">
        </div>
        <div id="file-list" class="flex flex-col gap-2 mt-4"></div>
    </div>

    <div class="form-group">
        <label class="form-label">Caption</label>
        <textarea id="caption" class="form-control" rows="5" placeholder="Write your caption here..."></textarea>
        <div class="flex justify-between text-sm text-muted mt-1">
            <span id="char-count">0 / 2200</span>
            <span id="hashtag-count">0 / 30 hashtags</span>
        </div>
    </div>

    <!-- Auto-DM Section -->
    <div class="form-group" style="border-top: 1px solid var(--border); padding-top: 1rem; margin-top: 1rem;">
        <label class="form-label flex items-center gap-2" style="cursor: pointer;">
            <input type="checkbox" id="auto-dm-toggle" checked onchange="toggleAutoDM()"> 
            Enable Auto-DM for this post
        </label>
        <div class="text-sm text-muted">Instagram allows DMs only if the user messaged you first (24h window). Commenting alone does not open DMs.</div>
        <div id="auto-dm-settings" class="hidden mt-2" style="margin-top: 0.5rem; padding-left: 1.5rem;">
            <div class="form-group">
                <label class="form-label text-sm">Link or File URL to Send</label>
                <input type="url" id="dm-link" class="form-control" placeholder="https://example.com/ebook.pdf">
                <div class="text-sm text-muted">Enter a direct URL to a PDF, image, or link</div>
            </div>
            <div class="form-group">
                <label class="form-label text-sm">Trigger Keyword (Optional)</label>
                <input type="text" id="dm-trigger" class="form-control" placeholder="e.g. SENDME">
                <div class="text-sm text-muted">Leave empty to reply to ANY comment (default: AUTO)</div>
            </div>
            <div class="form-group">
                <label class="form-label text-sm flex items-center gap-2" style="cursor: pointer;">
                    <input type="checkbox" id="auto-dm-ai-toggle">
                    Use AI Replies
                </label>
                <div class="text-sm text-muted">Generate DM text with AI (default: off)</div>
            </div>
        </div>
    </div>

    <div class="form-group" style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
        <button id="submit-btn" class="btn btn-primary w-full" onclick="submitPost()" style="padding: 0.875rem 2rem; font-size: 1rem;">
            <span>üöÄ</span> Post Now
        </button>
    </div>
</div>

<!-- Modal for success/error -->
<div id="result-modal" class="modal hidden">
    <div class="modal-content card">
        <h3 id="modal-title">Result</h3>
        <p id="modal-message"></p>
        <button class="btn btn-primary" onclick="closeModal()">Close</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/posting.js"></script>
{% endblock %}
