{% extends "layout.html" %}

{% block title %}Posting{% endblock %}
{% block page_title %}New Post{% endblock %}

{% block content %}
<div class="card">
    <div class="form-group">
        <label class="form-label">Select Accounts</label>
        <div id="account-selector" class="grid grid-3">
            <div class="text-muted">Loading accounts...</div>
        </div>
    </div>

    <div class="form-group">
        <label class="form-label">Media Type</label>
        <div class="flex gap-2" id="media-type-buttons">
            <button type="button" class="btn btn-primary" data-type="image" onclick="setMediaType('image')">Image</button>
            <button type="button" class="btn btn-secondary" data-type="video" onclick="setMediaType('video')">Video</button>
            <button type="button" class="btn btn-secondary" data-type="reels" onclick="setMediaType('reels')">Reels</button>
            <button type="button" class="btn btn-secondary" data-type="carousel" onclick="setMediaType('carousel')">Carousel</button>
        </div>
        <input type="hidden" id="media-type" value="image">
    </div>

    <div class="form-group">
        <label class="form-label flex items-center gap-2" style="cursor: pointer;">
            <input type="checkbox" id="post-by-url-toggle" onchange="togglePostByUrl()">
            Post by URL (recommended for videos)
        </label>
        <div class="text-sm text-muted">Use Cloudinary, Imgur, S3, or any public HTTPS URL. Avoid Cloudflare tunnel URLs.</div>
    </div>

    <div id="post-by-url-section" class="form-group hidden">
        <label class="form-label">Media URLs</label>
        <textarea id="media-urls" class="form-control" rows="3" placeholder="https://res.cloudinary.com/.../video.mp4&#10;https://i.imgur.com/abc.png"></textarea>
        <div class="text-sm text-muted">One URL per line. Image: .jpg .png .webp. Video: .mp4 .mov</div>
    </div>

    <div id="upload-section" class="form-group">
        <label class="form-label">Upload Media</label>
        <div id="drop-zone" class="upload-zone">
            <div class="upload-content">
                <span class="icon" style="font-size: 2rem;">☁️</span>
                <p>Drag & drop files here or click to select</p>
                <div class="text-sm text-muted">Supports JPG, PNG, MP4, MOV</div>
            </div>
            <input type="file" id="file-input" class="hidden" multiple accept="image/*,video/*">
        </div>
        <div id="file-list" class="flex flex-col gap-2 mt-4"></div>
    </div>

    <div class="form-group">
        <label class="form-label">Caption</label>
        <textarea id="caption" class="form-control" rows="5" placeholder="Write your caption here..."></textarea>
        <div class="flex justify-between text-sm text-muted mt-1">
            <span id="char-count">0 / 2200</span>
            <span id="hashtag-count">0 / 30 hashtags</span>
        </div>
    </div>

    <div class="form-group">
        <label class="form-label">Schedule (Optional)</label>
        <input type="datetime-local" id="scheduled-time" class="form-control">
    </div>

    <!-- Auto-DM Section -->
    <div class="form-group" style="border-top: 1px solid var(--border); padding-top: 1rem; margin-top: 1rem;">
        <label class="form-label flex items-center gap-2" style="cursor: pointer;">
            <input type="checkbox" id="auto-dm-toggle" checked onchange="toggleAutoDM()"> 
            Enable Auto-DM for this post
        </label>
        <div class="text-sm text-muted">Instagram allows DMs only if the user messaged you first (24h window). Commenting alone does not open DMs.</div>
        <div id="auto-dm-settings" class="hidden mt-2" style="margin-top: 0.5rem; padding-left: 1.5rem;">
            <div class="form-group">
                <label class="form-label text-sm">Link or File URL to Send</label>
                <input type="url" id="dm-link" class="form-control" placeholder="https://example.com/ebook.pdf">
                <div class="text-sm text-muted">Enter a direct URL to a PDF, image, or link</div>
            </div>
            <div class="form-group">
                <label class="form-label text-sm">Trigger Keyword (Optional)</label>
                <input type="text" id="dm-trigger" class="form-control" placeholder="e.g. SENDME">
                <div class="text-sm text-muted">Leave empty to reply to ANY comment (default: AUTO)</div>
            </div>
        </div>
    </div>

    <div class="form-group">
        <button id="submit-btn" class="btn btn-primary w-full" onclick="submitPost()">Post Now</button>
    </div>
</div>

<!-- Modal for success/error -->
<div id="result-modal" class="modal hidden">
    <div class="modal-content card">
        <h3 id="modal-title">Result</h3>
        <p id="modal-message"></p>
        <button class="btn btn-primary" onclick="closeModal()">Close</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/posting.js"></script>
{% endblock %}
