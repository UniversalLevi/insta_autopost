{% extends "layout.html" %}

{% block title %}Webhook Test - InstaForge{% endblock %}

{% block page_title %}Webhook & AI DM Test{% endblock %}

{% block content %}
<div class="webhook-test-page">
    <div class="page-header">
        <div class="header-actions">
            <button id="refresh-status" class="btn btn-primary">
                <span class="icon">üîÑ</span> Refresh Status
            </button>
            <button id="test-webhook" class="btn btn-secondary">
                <span class="icon">üß™</span> Test Webhook
            </button>
        </div>
    </div>

    <!-- Webhook Configuration (matches Meta app setup) - Rendered server-side, no spinner -->
    <div class="card">
        <h2>üì° Webhook Configuration</h2>
        <p class="text-sm text-muted" style="margin-bottom: 1rem;">Use these values in your Meta app. Callback URL must be the <strong>production URL</strong> below, not this page.</p>
        <div id="webhook-config">
            <div class="status-item ok" style="margin-bottom: 1rem;">
                <div class="status-label"><strong>Production URL (use this in Meta)</strong></div>
                <div class="code-block-wrap" style="margin-top: 6px; display: flex; gap: 8px; align-items: flex-start;">
                    <div class="code-block" style="flex: 1; word-break: break-all;" id="webhook-url">{{ (webhook_config or {}).get('production_url', 'https://veilforce.com/webhooks/instagram') }}</div>
                    <button type="button" class="btn-copy" onclick="copyToClipboard('webhook-url', this)">Copy</button>
                </div>
                <div class="text-sm text-muted" style="margin-top: 4px;">In Meta app ‚Üí Webhooks ‚Üí Configure ‚Üí Callback URL = this URL</div>
            </div>
            <div class="status-item ok" style="margin-bottom: 1rem;">
                <div class="status-label"><strong>Verify Token (use this in Meta)</strong></div>
                <div class="code-block-wrap" style="margin-top: 6px; display: flex; gap: 8px; align-items: flex-start;">
                    <div class="code-block" style="flex: 1;" id="webhook-verify">{{ (webhook_config or {}).get('verify_token', 'my_test_token_for_instagram_verification') }}</div>
                    <button type="button" class="btn-copy" onclick="copyToClipboard('webhook-verify', this)">Copy</button>
                </div>
                <div class="text-sm text-muted" style="margin-top: 4px;">In Meta app ‚Üí Webhooks ‚Üí Configure ‚Üí Verify token = this value</div>
            </div>
            <div class="status-item warning" style="margin-top: 1rem; padding: 12px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                <strong>Important:</strong> Do NOT use <code>/api/webhooks/callback-url</code> as Callback URL in Meta. Use the Production URL above (<code>.../webhooks/instagram</code>). Set <code>BASE_URL</code> in your server environment for your production domain.
            </div>
        </div>
    </div>

    <!-- AI DM Status -->
    <div class="card">
        <h2>ü§ñ AI DM Auto-Reply Status</h2>
        <div id="ai-dm-status" class="webhook-loading-state">
            <span class="loading-spinner-inline"></span>
            <span>Loading AI DM status...</span>
        </div>
    </div>

    <!-- Test Webhook Event -->
    <div class="card">
        <h2>üß™ Test Webhook Event</h2>
        <div class="form-group">
            <label class="form-label">Select Account</label>
            <select id="test-account-select" class="form-control">
                <option value="">Loading accounts...</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Test Message</label>
            <input type="text" id="test-message" class="form-control" placeholder="Hello, test message" value="Hello, this is a test message">
        </div>
        <div class="form-group">
            <label class="form-label">User ID (optional)</label>
            <input type="text" id="test-user-id" class="form-control" placeholder="test_user_123">
        </div>
        <button id="send-test-webhook" class="btn btn-primary">Send Test Webhook Event</button>
        <div id="test-result" class="mt-3"></div>
    </div>

    <!-- Instructions -->
    <div class="card">
        <h2>üìã How to Test</h2>
        <div class="instructions">
            <h3>1. Check Configuration</h3>
            <ul>
                <li>Verify webhook callback URL is correct in Meta App Dashboard</li>
                <li>Ensure verify token matches</li>
                <li>Check that AI DM is enabled for your account</li>
            </ul>

            <h3>2. Test via Webhook</h3>
            <ul>
                <li>Use the "Test Webhook" button above to simulate an incoming DM</li>
                <li>Or send a real DM from another Instagram account to your business account</li>
                <li>Check logs for webhook processing</li>
            </ul>

            <h3>3. Verify Response</h3>
            <ul>
                <li>Check if AI reply was generated</li>
                <li>Verify reply was sent back via Instagram API</li>
                <li>Check rate limiting (max 10 replies per user per day)</li>
            </ul>

            <h3>4. Troubleshooting</h3>
            <ul>
                <li><strong>No reply:</strong> Check if AI DM is enabled for account</li>
                <li><strong>OpenAI error:</strong> Verify OPENAI_API_KEY is set</li>
                <li><strong>Webhook not received:</strong> Check callback URL in Meta App Dashboard</li>
                <li><strong>24h window error:</strong> User must have messaged you first within 24 hours</li>
            </ul>
        </div>
    </div>
</div>

<style>
.webhook-test-page {
    padding: 20px;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.header-actions {
    display: flex;
    gap: 12px;
}

.card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.card h2 {
    margin-top: 0;
    margin-bottom: 16px;
    font-size: 20px;
}

.status-item {
    padding: 12px;
    background: #f9fafb;
    border-radius: 6px;
    margin-bottom: 8px;
    border-left: 3px solid #ccc;
}

.status-item.ok {
    border-left-color: #10b981;
}

.status-item.error {
    border-left-color: #ef4444;
}

.status-item.warning {
    border-left-color: #f59e0b;
}

.status-label {
    font-weight: 600;
    margin-bottom: 4px;
}

.status-value {
    color: #6b7280;
    font-size: 14px;
}

.account-status {
    padding: 16px;
    background: #f9fafb;
    border-radius: 6px;
    margin-bottom: 12px;
}

.account-status.enabled {
    border-left: 4px solid #10b981;
}

.account-status.disabled {
    border-left: 4px solid #6b7280;
}

.account-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.account-name {
    font-weight: 600;
    font-size: 16px;
}

.status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-badge.enabled {
    background: #d1fae5;
    color: #065f46;
}

.status-badge.disabled {
    background: #f3f4f6;
    color: #374151;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #6b7280;
}

.webhook-loading-state {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 24px;
    color: #6b7280;
}

.loading-spinner-inline {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid #e5e7eb;
    border-top-color: #6366f1;
    border-radius: 50%;
    animation: webhook-spin 0.8s linear infinite;
}

@keyframes webhook-spin {
    to { transform: rotate(360deg); }
}

.error-message {
    background: #fee2e2;
    color: #991b1b;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 20px;
}

.success-message {
    background: #d1fae5;
    color: #065f46;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 20px;
}

.instructions h3 {
    margin-top: 20px;
    margin-bottom: 8px;
    font-size: 16px;
}

.instructions ul {
    margin-left: 20px;
    margin-bottom: 16px;
}

.instructions li {
    margin-bottom: 4px;
}

.code-block {
    background: #1f2937;
    color: #f9fafb;
    padding: 12px;
    border-radius: 6px;
    font-family: monospace;
    font-size: 14px;
    overflow-x: auto;
    margin: 8px 0;
}

.btn-copy {
    padding: 8px 14px;
    font-size: 13px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    white-space: nowrap;
    flex-shrink: 0;
}

.btn-copy:hover {
    background: var(--primary-dark);
}

.btn-copy.copied {
    background: var(--success);
}
</style>

<script>
let refreshInterval = null;

function copyToClipboard(elementId, btn) {
    const el = document.getElementById(elementId);
    if (!el) return;
    const text = el.textContent || '';
    navigator.clipboard.writeText(text).then(() => {
        const orig = btn.textContent;
        btn.textContent = 'Copied!';
        btn.classList.add('copied');
        setTimeout(() => { btn.textContent = orig; btn.classList.remove('copied'); }, 2000);
    }).catch(() => alert('Copy failed'));
}

function escapeHtml(str) {
    if (str == null) return '';
    const div = document.createElement('div');
    div.textContent = String(str);
    return div.innerHTML;
}

async function loadWebhookConfig() {
    const container = document.getElementById('webhook-config');
    if (!container) return;
    container.innerHTML = '<div class="webhook-loading-state"><span class="loading-spinner-inline"></span><span>Refreshing...</span></div>';
    try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 10000);
        const response = await fetch('/api/webhooks/callback-url', { credentials: 'include', signal: controller.signal });
        clearTimeout(timeout);
        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
            throw new Error(data.detail || data.message || 'HTTP ' + response.status);
        }
        const prodUrl = data.production_url || data.meta_callback_url || 'https://veilforce.com/webhooks/instagram';
        const verifyToken = data.verify_token || 'Not set';
        const html = '<div class="status-item ok" style="margin-bottom: 1rem;">' +
            '<div class="status-label"><strong>Production URL (use this in Meta)</strong></div>' +
            '<div class="code-block-wrap" style="margin-top: 6px; display: flex; gap: 8px; align-items: flex-start;">' +
            '<div class="code-block" style="flex: 1; word-break: break-all;" id="webhook-url">' + escapeHtml(prodUrl) + '</div>' +
            '<button type="button" class="btn-copy" onclick="copyToClipboard(\'webhook-url\', this)">Copy</button></div>' +
            '<div class="text-sm text-muted" style="margin-top: 4px;">In Meta app ‚Üí Webhooks ‚Üí Configure ‚Üí Callback URL = this URL</div></div>' +
            '<div class="status-item ok" style="margin-bottom: 1rem;">' +
            '<div class="status-label"><strong>Verify Token (use this in Meta)</strong></div>' +
            '<div class="code-block-wrap" style="margin-top: 6px; display: flex; gap: 8px; align-items: flex-start;">' +
            '<div class="code-block" style="flex: 1;" id="webhook-verify">' + escapeHtml(verifyToken) + '</div>' +
            '<button type="button" class="btn-copy" onclick="copyToClipboard(\'webhook-verify\', this)">Copy</button></div>' +
            '<div class="text-sm text-muted" style="margin-top: 4px;">In Meta app ‚Üí Verify token = this value</div></div>' +
            '<div class="status-item warning" style="margin-top: 1rem; padding: 12px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">' +
            '<strong>Important:</strong> Do NOT use <code>/api/webhooks/callback-url</code> as Callback URL. Use the Production URL above. Set <code>BASE_URL</code> in your server environment.</div>';
        container.innerHTML = html;
    } catch (error) {
        console.error('Error loading webhook config:', error);
        container.innerHTML = '<div class="error-message">Error loading webhook configuration: ' + escapeHtml(error.message || 'Unknown error') + '</div>';
    }
}

async function loadAIDMStatus() {
    const container = document.getElementById('ai-dm-status');
    if (!container) return;
    container.innerHTML = '<div class="webhook-loading-state"><span class="loading-spinner-inline"></span><span>Loading AI DM status...</span></div>';
    try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 10000);
        const response = await fetch('/api/test/ai-dm-status', { credentials: 'include', signal: controller.signal });
        clearTimeout(timeout);
        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
            throw new Error(data.detail || data.error || 'HTTP ' + response.status);
        }
        
        if (!data.openai_configured) {
            container.innerHTML = '<div class="error-message">‚ö†Ô∏è OpenAI API key not configured. Set OPENAI_API_KEY environment variable.</div>';
            return;
        }
        
        if (data.accounts.length === 0) {
            container.innerHTML = '<div class="status-item warning">No accounts configured</div>';
            return;
        }
        
        const accountsHtml = data.accounts.map(acc => {
            const enabled = acc.ai_dm_enabled;
            return `
                <div class="account-status ${enabled ? 'enabled' : 'disabled'}">
                    <div class="account-header">
                        <div class="account-name">${acc.username || acc.account_id}</div>
                        <span class="status-badge ${enabled ? 'enabled' : 'disabled'}">
                            ${enabled ? 'Enabled' : 'Disabled'}
                        </span>
                    </div>
                    <div class="status-value" style="margin-top: 8px;">
                        <strong>Account ID:</strong> ${acc.account_id}<br>
                        <strong>Instagram Business ID:</strong> ${acc.instagram_business_id || 'Not set'}<br>
                        <strong>AI DM Config:</strong> ${acc.has_ai_dm_config ? 'Yes' : 'No'}
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = accountsHtml;
        
        // Also populate account selector for test
        const select = document.getElementById('test-account-select');
        select.innerHTML = '<option value="">Select account...</option>' + 
            data.accounts.map(acc => 
                `<option value="${acc.account_id}" ${acc.ai_dm_enabled ? '' : 'disabled'}>
                    ${acc.username || acc.account_id} ${acc.ai_dm_enabled ? '' : '(AI DM disabled)'}
                </option>`
            ).join('');
    } catch (error) {
        console.error('Error loading AI DM status:', error);
        container.innerHTML = '<div class="error-message">Error loading AI DM status: ' + (error.message || 'Unknown error') + '</div>';
    }
}

async function testWebhook() {
    const accountId = document.getElementById('test-account-select').value;
    const message = document.getElementById('test-message').value;
    const userId = document.getElementById('test-user-id').value || 'test_user_123';
    const resultDiv = document.getElementById('test-result');
    
    if (!accountId) {
        resultDiv.innerHTML = '<div class="error-message">Please select an account</div>';
        return;
    }
    
    if (!message) {
        resultDiv.innerHTML = '<div class="error-message">Please enter a test message</div>';
        return;
    }
    
    resultDiv.innerHTML = '<div class="loading">Sending test webhook event...</div>';
    
    try {
        const formData = new FormData();
        formData.append('message', message);
        formData.append('user_id', userId);
        formData.append('account_id', accountId);
        
        const response = await fetch('/api/test/ai-reply', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            resultDiv.innerHTML = `
                <div class="success-message">
                    <strong>‚úÖ Test successful!</strong><br>
                    <strong>Reply:</strong> ${data.reply_text || 'No reply generated'}<br>
                    <strong>Status:</strong> ${data.reply_status || 'unknown'}<br>
                    ${data.reason ? `<strong>Reason:</strong> ${data.reason}` : ''}
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="error-message">
                    <strong>‚ùå Test failed</strong><br>
                    ${data.error || data.detail || 'Unknown error'}
                </div>
            `;
        }
    } catch (error) {
        console.error('Error testing webhook:', error);
        resultDiv.innerHTML = '<div class="error-message">Error: ' + error.message + '</div>';
    }
}

document.getElementById('refresh-status').addEventListener('click', () => {
    loadWebhookConfig();  // Refresh overwrites server-rendered config
    loadAIDMStatus();
});

document.getElementById('test-webhook').addEventListener('click', () => {
    document.getElementById('test-result').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    testWebhook();
});

document.getElementById('send-test-webhook').addEventListener('click', testWebhook);

// Load on page load - webhook config is server-rendered, only load AI DM status
loadAIDMStatus();

// Auto-refresh AI DM status every 30 seconds
refreshInterval = setInterval(() => {
    loadAIDMStatus();
}, 30000);

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>
{% endblock %}
