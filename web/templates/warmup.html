{% extends "layout.html" %}

{% block title %}5-Day Warm-Up - InstaForge{% endblock %}

{% block page_title %}Instagram 5-Day Account Warm-Up{% endblock %}

{% block content %}
<div class="warmup-page">
    <div class="page-header">
        <p class="warmup-desc">Help old or risky accounts regain trust safely. Manual guidance + light automation.</p>
        <div class="header-actions">
            <button id="refresh-warmup" class="btn btn-primary">
                <span class="icon">ðŸ”„</span> Refresh
            </button>
        </div>
    </div>

    <div id="warmup-loading" class="warmup-loading" style="display: flex;">
        <span class="loading-spinner-inline"></span>
        <span>Loading warm-up status...</span>
    </div>

    <div id="warmup-content" style="display: none;">
        <div class="card warmup-account-select">
            <label class="form-label">Select Account</label>
            <select id="warmup-account" class="form-control">
                <option value="">Loading...</option>
            </select>
        </div>

        <div id="warmup-no-plan" class="card warmup-empty" style="display: none;">
            <h3>No active warm-up</h3>
            <p>Start a 5-day warm-up to safely restore account trust.</p>
            <button id="start-warmup-btn" class="btn btn-primary">Start Warm-Up</button>
        </div>

        <div id="warmup-dashboard" class="warmup-dashboard" style="display: none;">
            <div class="warmup-status-card">
                <div class="status-row">
                    <span class="status-label">Day</span>
                    <span id="warmup-day" class="status-value">â€”</span>
                    <span class="status-badge" id="warmup-status-badge">active</span>
                </div>
                <div class="progress-bar-wrap">
                    <div class="progress-bar" id="warmup-progress"></div>
                </div>
                <div class="risk-row">
                    <span class="risk-label">Risk Score</span>
                    <span id="warmup-risk" class="risk-value risk-low">0</span>
                </div>
            </div>

            <div class="card warmup-automation">
                <h3>Automation</h3>
                <p class="text-sm text-muted">Enable to auto-run like, comment, save from hashtag discovery.</p>
                <div class="warmup-proxy-hint">
                    <strong>Local setup (laptop):</strong> (1) Install Playwright: <code>pip install playwright && playwright install chromium</code>. (2) Set your Instagram password in <strong>Settings â†’ Accounts â†’ Edit</strong> (required for browser login). (3) Restart the app after installing Playwright.
                </div>
                <div class="warmup-proxy-hint" style="margin-top: 8px;">
                    <strong>Post discovery</strong> uses the Instagram website in a browser. On a server, use a residential proxy in <strong>Settings â†’ Global Proxy</strong>. On a home network, no proxy is neededâ€”if proxy fails, it will retry without proxy automatically.
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="automation-enabled" />
                        Enable automation
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-label">Target hashtags (comma-separated)</label>
                    <input type="text" id="automation-hashtags" class="form-control" placeholder="fitness, travel, photography" />
                </div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button id="save-automation-btn" class="btn btn-secondary">Save automation settings</button>
                    <button id="run-automation-now-btn" class="btn btn-primary">Run automation now</button>
                </div>
                <div id="warmup-live-progress" class="warmup-live-progress" style="display: none;">
                    <div class="live-progress-header">
                        <span class="loading-spinner-inline"></span>
                        <strong>Live progress</strong>
                        <button id="stop-warmup-btn" class="btn btn-danger btn-sm" style="margin-left: auto;">Stop Warmup</button>
                    </div>
                    <div id="live-progress-message" class="live-progress-message">â€”</div>
                    <div id="live-progress-stats" class="live-progress-stats"></div>
                </div>
            </div>

            <div class="card warmup-tasks">
                <h3>Today's Tasks</h3>
                <div id="warmup-tasks-list" class="tasks-list"></div>
                <div class="warmup-actions">
                    <button id="complete-day-btn" class="btn btn-secondary">Complete Day & Continue</button>
                    <button id="pause-warmup-btn" class="btn btn-secondary btn-warning">Pause Warm-Up</button>
                </div>
            </div>

            <div id="warmup-warnings" class="card warmup-warnings" style="display: none;"></div>
        </div>

        <div id="warmup-paused" class="card warmup-paused" style="display: none;">
            <h3>Warm-up paused</h3>
            <p id="pause-reason">â€”</p>
            <button id="resume-warmup-btn" class="btn btn-primary">Resume Warm-Up</button>
        </div>

        <div id="warmup-completed" class="card warmup-completed" style="display: none;">
            <h3>âœ… Warm-up completed</h3>
            <p>Account is ready for normal automation.</p>
        </div>
    </div>

    <div id="warmup-error" class="error-message" style="display: none;"></div>
</div>

<style>
.warmup-page { padding: 20px; }
.warmup-desc { color: var(--text-muted); margin-bottom: 16px; }
.page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
.warmup-loading { display: flex; align-items: center; gap: 12px; padding: 24px; color: var(--text-muted); }
.loading-spinner-inline { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: warmup-spin 0.8s linear infinite; }
@keyframes warmup-spin { to { transform: rotate(360deg); } }

.warmup-account-select { margin-bottom: 20px; max-width: 400px; }
.warmup-empty, .warmup-paused, .warmup-completed { text-align: center; padding: 40px; }
.warmup-dashboard { display: grid; gap: 20px; }
.warmup-status-card { background: var(--bg-card); border-radius: 8px; padding: 20px; border-left: 4px solid var(--success); border: 1px solid var(--border); border-left-width: 4px; }
.status-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
.status-label { font-weight: 600; color: var(--text-muted); }
.status-value { font-size: 18px; font-weight: 700; color: var(--primary); }
.status-badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
.status-badge.active { background: var(--success-light); color: #86EFAC; }
.status-badge.paused { background: var(--warning-light); color: #FCD34D; }
.status-badge.completed { background: var(--info-light); color: #93C5FD; }
.progress-bar-wrap { height: 8px; background: var(--bg-hover); border-radius: 4px; overflow: hidden; margin: 12px 0; }
.progress-bar { height: 100%; background: linear-gradient(90deg, var(--success), var(--primary)); transition: width 0.3s; }
.risk-row { margin-top: 12px; font-size: 14px; color: var(--text-muted); }
.risk-value.risk-low { color: var(--success); }
.risk-value.risk-mid { color: var(--warning); }
.risk-value.risk-high { color: var(--error); }

.warmup-tasks h3 { margin: 0 0 16px 0; font-size: 18px; color: var(--text); }
.tasks-list { display: grid; gap: 10px; margin-bottom: 20px; }
.task-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-elevated); border-radius: 6px; border-left: 3px solid var(--border); color: var(--text); }
.task-item.done { border-left-color: var(--success); background: var(--success-light); }
.task-item .task-check { width: 20px; height: 20px; border-radius: 4px; border: 2px solid var(--border); flex-shrink: 0; }
.task-item.done .task-check { background: var(--success); border-color: var(--success); }
.task-item .task-label { flex: 1; }
.task-item .task-count { color: var(--text-muted); font-size: 13px; }
.warmup-actions { display: flex; gap: 12px; flex-wrap: wrap; }
.btn-warning { border-color: var(--warning); color: #FCD34D; }
.warmup-warnings { background: var(--warning-light); border-left: 4px solid var(--warning); color: #FCD34D; }
.warmup-proxy-hint { font-size: 0.8125rem; color: var(--text-muted); background: var(--info-light); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; padding: 10px 12px; margin-bottom: 16px; }
.warmup-page .error-message { background: var(--error-light); color: #FCA5A5; padding: 12px; border-radius: 6px; margin-top: 20px; border: 1px solid rgba(239, 68, 68, 0.3); }
.warmup-automation { margin-bottom: 20px; }
.warmup-automation h3, .warmup-tasks h3, .warmup-empty h3, .warmup-paused h3, .warmup-completed h3 { color: var(--text); }
.warmup-empty p, .warmup-paused p, .warmup-completed p { color: var(--text-muted); }
.checkbox-label { display: flex; align-items: center; gap: 8px; cursor: pointer; color: var(--text); }
.checkbox-label input { width: auto; }
.warmup-proxy-hint code { background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-size: 0.85em; }
.warmup-live-progress { margin-top: 16px; padding: 16px; background: var(--bg-elevated); border-radius: 8px; border: 1px solid var(--border); border-left: 4px solid var(--primary); }
.live-progress-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; color: var(--text); flex-wrap: wrap; }
.btn-sm { padding: 0.25rem 0.5rem; font-size: 0.8rem; }
.live-progress-message { color: var(--text-muted); font-size: 0.95rem; }
.live-progress-stats { margin-top: 8px; font-size: 0.85rem; color: var(--text-subtle); }
</style>

<script>
const api = (path, opts = {}) => fetch('/api/warmup' + path, { credentials: 'include', ...opts });

async function loadAccounts() {
    try {
        const r = await fetch('/api/config/accounts', { credentials: 'include' });
        const d = await r.json();
        const sel = document.getElementById('warmup-account');
        sel.innerHTML = '<option value="">Select account...</option>' + (d.accounts || []).map(a =>
            `<option value="${a.account_id}">${a.username || a.account_id}</option>`
        ).join('');
        return d.accounts || [];
    } catch (e) {
        console.error(e);
        document.getElementById('warmup-error').textContent = 'Failed to load accounts: ' + (e.message || 'Check console');
        document.getElementById('warmup-error').style.display = 'block';
        return [];
    }
}

async function loadWarmupStatus() {
    const accountId = document.getElementById('warmup-account').value;
    if (!accountId) {
        document.getElementById('warmup-no-plan').style.display = 'block';
        document.getElementById('warmup-dashboard').style.display = 'none';
        document.getElementById('warmup-paused').style.display = 'none';
        document.getElementById('warmup-completed').style.display = 'none';
        return;
    }
    document.getElementById('warmup-loading').style.display = 'flex';
    document.getElementById('warmup-error').style.display = 'none';
    try {
        const r = await api('/status?account_id=' + encodeURIComponent(accountId));
        const d = await r.json();
        if (!r.ok) throw new Error(d.detail || 'Failed to load status');
        renderStatus(d, accountId);
    } catch (e) {
        document.getElementById('warmup-error').textContent = e.message || 'Error';
        document.getElementById('warmup-error').style.display = 'block';
    } finally {
        document.getElementById('warmup-loading').style.display = 'none';
    }
}

function renderStatus(data, accountId) {
    accountId = accountId || document.getElementById('warmup-account').value;
    const hasPlan = data.plan != null;
    const plan = data.plan || {};
    const status = plan.status || 'none';

    document.getElementById('warmup-no-plan').style.display = (!hasPlan || status === 'none') ? 'block' : 'none';
    document.getElementById('warmup-dashboard').style.display = (hasPlan && status === 'active') ? 'block' : 'none';
    document.getElementById('warmup-paused').style.display = (hasPlan && status === 'paused') ? 'block' : 'none';
    document.getElementById('warmup-completed').style.display = (hasPlan && status === 'completed') ? 'block' : 'none';

    if (hasPlan && status === 'paused') {
        document.getElementById('pause-reason').textContent = plan.notes || 'Paused by user';
    }

    if (hasPlan && status === 'active') {
        const day = plan.current_day || 1;
        document.getElementById('warmup-day').textContent = day + ' / 5';
        document.getElementById('warmup-progress').style.width = (day / 5 * 100) + '%';
        const risk = plan.risk_score || 0;
        const riskEl = document.getElementById('warmup-risk');
        riskEl.textContent = risk;
        riskEl.className = 'risk-value ' + (risk >= 80 ? 'risk-high' : risk >= 50 ? 'risk-mid' : 'risk-low');
        document.getElementById('warmup-status-badge').textContent = 'active';
        document.getElementById('warmup-status-badge').className = 'status-badge active';

        loadAutomationConfig(accountId);

        const tasks = (data.tasks || []).map(t => `
            <div class="task-item ${t.completed ? 'done' : ''}" data-task-id="${t.id}">
                <div class="task-check"></div>
                <div class="task-label">${t.label}</div>
                <div class="task-count">${t.done_count || 0} / ${t.target || 1}</div>
            </div>
        `).join('');
        document.getElementById('warmup-tasks-list').innerHTML = tasks || '<p class="text-muted">No tasks for today.</p>';
    }
}

document.getElementById('start-warmup-btn').addEventListener('click', async () => {
    const accountId = document.getElementById('warmup-account').value;
    if (!accountId) { alert('Select an account'); return; }
    try {
        const r = await api('/start', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ account_id: accountId }) });
        const d = await r.json();
        if (!r.ok) throw new Error(d.detail || 'Failed');
        loadWarmupStatus();
    } catch (e) {
        alert(e.message || 'Failed to start warm-up');
    }
});

document.getElementById('complete-day-btn').addEventListener('click', async () => {
    const accountId = document.getElementById('warmup-account').value;
    if (!accountId) return;
    if (!confirm('Mark today as complete and advance to next day?')) return;
    try {
        const r = await api('/complete-day', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ account_id: accountId }) });
        const d = await r.json();
        if (!r.ok) throw new Error(d.detail || 'Failed');
        loadWarmupStatus();
    } catch (e) {
        alert(e.message || 'Failed');
    }
});

document.getElementById('pause-warmup-btn').addEventListener('click', async () => {
    const accountId = document.getElementById('warmup-account').value;
    if (!accountId) return;
    const reason = prompt('Reason for pause (optional):') || 'Paused by user';
    try {
        const r = await api('/pause', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ account_id: accountId, reason }) });
        const d = await r.json();
        if (!r.ok) throw new Error(d.detail || 'Failed');
        loadWarmupStatus();
    } catch (e) {
        alert(e.message || 'Failed');
    }
});

document.getElementById('resume-warmup-btn').addEventListener('click', async () => {
    const accountId = document.getElementById('warmup-account').value;
    if (!accountId) return;
    try {
        const r = await api('/resume', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ account_id: accountId }) });
        const d = await r.json();
        if (!r.ok) throw new Error(d.detail || 'Failed');
        loadWarmupStatus();
    } catch (e) {
        alert(e.message || 'Failed');
    }
});

async function loadAutomationConfig(accountId) {
    if (!accountId) return;
    try {
        const r = await fetch('/api/warmup/automation-config?account_id=' + encodeURIComponent(accountId), { credentials: 'include' });
        const cfg = await r.json();
        document.getElementById('automation-enabled').checked = cfg.automation_enabled || false;
        document.getElementById('automation-hashtags').value = (cfg.target_hashtags || []).join(', ');
    } catch (e) {
        console.error('Failed to load automation config', e);
    }
}

async function runAutomationWithAutoEnable(accountId, signal) {
    const r = await fetch('/api/warmup/run-automation', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ account_id: accountId }),
        signal: signal || null,
    });
    const d = await r.json();
    if (!r.ok) {
        const detail = typeof d.detail === 'string' ? d.detail : (Array.isArray(d.detail) ? d.detail.map(x => x.msg || x).join(', ') : JSON.stringify(d.detail || 'Failed'));
        throw new Error(detail);
    }
    return d;
}

document.getElementById('run-automation-now-btn').addEventListener('click', async () => {
    const accountId = document.getElementById('warmup-account').value;
    if (!accountId) { alert('Select an account'); return; }
    const btn = document.getElementById('run-automation-now-btn');
    const progressEl = document.getElementById('warmup-live-progress');
    const msgEl = document.getElementById('live-progress-message');
    const statsEl = document.getElementById('live-progress-stats');
    btn.disabled = true;
    btn.textContent = 'Running...';
    progressEl.style.display = 'block';
    msgEl.textContent = 'Starting...';
    statsEl.textContent = '';

    let pollInterval = setInterval(async () => {
        try {
            const r = await fetch('/api/warmup/run-status?account_id=' + encodeURIComponent(accountId), { credentials: 'include' });
            const p = await r.json();
            if (p.message) msgEl.textContent = p.message;
            const parts = [];
            if ((p.actions || 0) > 0) parts.push(p.actions + ' action(s)');
            if ((p.errors || 0) > 0) parts.push(p.errors + ' error(s)');
            if (p.tasks_done && p.tasks_done.length) parts.push('Tasks: ' + p.tasks_done.join(', '));
            statsEl.textContent = parts.join(' Â· ');
        } catch (_) {}
    }, 2000);

    const stopBtn = document.getElementById('stop-warmup-btn');
    if (stopBtn) {
        stopBtn.onclick = async () => {
            stopBtn.disabled = true;
            stopBtn.textContent = 'Stopping...';
            try {
                await fetch('/api/warmup/stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ account_id: accountId }),
                });
                msgEl.textContent = 'Stop requested. Run will stop after current action.';
            } catch (e) {
                msgEl.textContent = 'Failed to send stop: ' + (e.message || '');
            }
        };
    }

    const abort = new AbortController();
    const timeoutId = setTimeout(() => abort.abort(), 190000);
    try {
        let d = await runAutomationWithAutoEnable(accountId, abort.signal);
        let msg = d.result?.message || '';
        if (msg.includes('Automation is disabled') && confirm('Automation is disabled. Enable it and run now?')) {
            const hashtags = document.getElementById('automation-hashtags').value.split(',').map(s => s.trim()).filter(Boolean);
            if (!hashtags.length) hashtags.push('explore');
            await fetch('/api/warmup/automation-config', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    account_id: accountId,
                    automation_enabled: true,
                    target_hashtags: hashtags,
                }),
            });
            document.getElementById('automation-enabled').checked = true;
            d = await runAutomationWithAutoEnable(accountId, abort.signal);
            msg = d.result?.message || '';
        }
        const actions = d.result?.actions ?? 0;
        msgEl.textContent = msg || ('Done! ' + actions + ' action(s).');
        statsEl.textContent = (actions > 0 ? actions + ' action(s) Â· ' : '') + (msg || '');
        loadWarmupStatus();
        setTimeout(() => { progressEl.style.display = 'none'; }, 8000);
    } catch (e) {
        if (e.name === 'AbortError') {
            msgEl.textContent = 'Timed out. The automation may still be running on the server. Use Stop Warmup to cancel it.';
        } else {
            msgEl.textContent = 'Error: ' + (e.message || String(e));
        }
    } finally {
        clearInterval(pollInterval);
        clearTimeout(timeoutId);
        btn.disabled = false;
        btn.textContent = 'Run automation now';
        if (stopBtn) {
            stopBtn.disabled = false;
            stopBtn.textContent = 'Stop Warmup';
        }
    }
});

document.getElementById('save-automation-btn').addEventListener('click', async () => {
    const accountId = document.getElementById('warmup-account').value;
    if (!accountId) { alert('Select an account'); return; }
    const hashtags = document.getElementById('automation-hashtags').value.split(',').map(s => s.trim()).filter(Boolean);
    if (!hashtags.length) hashtags.push('explore');
    try {
        const r = await fetch('/api/warmup/automation-config', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                account_id: accountId,
                automation_enabled: document.getElementById('automation-enabled').checked,
                target_hashtags: hashtags,
            }),
        });
        const d = await r.json();
        if (!r.ok) throw new Error(d.detail || 'Failed');
        alert('Automation settings saved');
    } catch (e) {
        alert(e.message || 'Failed to save');
    }
});

document.getElementById('refresh-warmup').addEventListener('click', () => {
    loadAccounts().then(() => loadWarmupStatus());
});

document.addEventListener('DOMContentLoaded', async () => {
    document.getElementById('warmup-content').style.display = 'block';
    document.getElementById('warmup-account').addEventListener('change', loadWarmupStatus);
    await loadAccounts();
    const accountId = document.getElementById('warmup-account').value;
    if (accountId) loadWarmupStatus();
    else document.getElementById('warmup-loading').style.display = 'none';
});
</script>
{% endblock %}
