{% extends "layout.html" %}

{% block title %}Account Status - InstaForge{% endblock %}

{% block page_title %}Account Status{% endblock %}

{% block content %}
<div class="accounts-status-page">
    <div class="page-header">
        <div class="header-actions">
            <button id="connect-account" class="btn btn-primary">
                <span class="icon">‚ûï</span> Connect Account
            </button>
            <button id="refresh-status" class="btn btn-primary">
                <span class="icon">üîÑ</span> Refresh Status
            </button>
            <button id="reload-accounts" class="btn btn-secondary">
                <span class="icon">‚ôªÔ∏è</span> Reload Accounts
            </button>
            <button id="run-warming" class="btn btn-secondary" title="Run warming actions now for all accounts with warming enabled">
                <span class="icon">üî•</span> Run Warming Now
            </button>
        </div>
    </div>

    <div id="warming-status" class="warming-status-card" style="display: none;"></div>

    <div id="health-summary" class="health-summary" style="display: none;"></div>

    <div id="accounts-list" class="accounts-list">
        <div class="loading" id="initial-loading"><div class="loading-spinner"></div>Loading account status...</div>
    </div>
</div>

<!-- Connect Account Modal -->
<div id="connect-account-modal" class="modal hidden" style="display: none;">
    <div class="modal-content card" style="position: relative; margin: 5% auto; max-width: 500px; max-height: 90vh; overflow-y: auto;">
        <h3>Connect Instagram Account</h3>
        <form id="connect-account-form" onsubmit="event.preventDefault(); saveConnectAccount();">
            <div class="form-group">
                <label class="form-label">Account ID (Instagram Business ID)</label>
                <input type="text" id="conn-acc-id" class="form-control" required placeholder="e.g. 17841444586383008">
                <div class="text-sm text-muted">Found in Meta Business Suite when you connect Instagram</div>
            </div>
            <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text" id="conn-acc-username" class="form-control" required placeholder="instagram_username">
            </div>
            <div class="form-group">
                <label class="form-label">Access Token</label>
                <textarea id="conn-acc-token" class="form-control" rows="3" required placeholder="Long-lived access token from Meta"></textarea>
                <div class="text-sm text-muted">Generate in Meta for Developers or Business Suite</div>
            </div>
            <div class="form-group">
                <label class="form-label">Instagram password (for warm-up)</label>
                <input type="password" id="conn-acc-password" class="form-control" autocomplete="off" placeholder="Optional ‚Äì for browser warm-up actions">
            </div>
            <div class="form-group">
                <label class="form-label flex items-center gap-2">
                    <input type="checkbox" id="conn-acc-warming" checked> Enable Warming
                </label>
            </div>
            <div class="form-group">
                <label class="form-label flex items-center gap-2">
                    <input type="checkbox" id="conn-acc-dm-enabled"> Enable Comment Auto-DM
                </label>
                <input type="url" id="conn-acc-dm-link" class="form-control mt-2" placeholder="https://example.com/file.pdf (public URL)" style="max-width: 100%;">
            </div>
            <div class="form-group">
                <label class="form-label flex items-center gap-2">
                    <input type="checkbox" id="conn-acc-ai-dm-enabled" checked> Enable AI DM auto-reply
                </label>
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button type="button" class="btn btn-secondary" onclick="closeConnectAccountModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Connect Account</button>
            </div>
        </form>
    </div>
</div>

<style>
.accounts-status-page {
    padding: 20px;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.header-actions {
    display: flex;
    gap: 12px;
}

.accounts-list {
    display: grid;
    gap: 20px;
}

.account-card {
    background: var(--bg-card);
    border-radius: 8px;
    padding: 20px;
    box-shadow: var(--shadow);
    border-left: 4px solid var(--border);
    border: 1px solid var(--border);
    transition: all 0.2s ease;
}

.account-card:hover {
    box-shadow: var(--shadow-md), 0 0 10px rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.2);
}

.account-card.healthy {
    border-left-color: var(--success);
    box-shadow: 0 0 10px rgba(16, 185, 129, 0.2);
}

.account-card.warning {
    border-left-color: var(--warning);
    box-shadow: 0 0 10px rgba(245, 158, 11, 0.2);
}

.account-card.critical {
    border-left-color: var(--primary);
    box-shadow: 0 0 15px rgba(220, 38, 38, 0.3);
}

.account-card.unknown {
    border-left-color: var(--text-muted);
}

.account-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.account-info h3 {
    margin: 0 0 4px 0;
    font-size: 18px;
    font-weight: 600;
    color: var(--text-main);
}

.account-info .account-id {
    color: var(--text-muted);
    font-size: 14px;
}

.status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    border: 1px solid;
}

.status-badge.healthy {
    background: var(--success-light);
    color: #6EE7B7;
    border-color: rgba(16, 185, 129, 0.3);
}

.status-badge.warning {
    background: var(--warning-light);
    color: #FCD34D;
    border-color: rgba(245, 158, 11, 0.3);
}

.status-badge.critical {
    background: var(--error-light);
    color: #FCA5A5;
    border-color: rgba(239, 68, 68, 0.3);
}

.status-badge.unknown {
    background: var(--bg-hover);
    color: var(--text-muted);
    border-color: var(--border);
}

.checks-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    margin-top: 16px;
}

.check-item {
    padding: 12px;
    background: var(--bg-hover);
    border-radius: 6px;
    border-left: 3px solid var(--border);
    color: var(--text-main);
}

.check-item.ok {
    border-left-color: var(--success);
    box-shadow: 0 0 5px rgba(16, 185, 129, 0.1);
}

.check-item.failed {
    border-left-color: var(--primary);
    box-shadow: 0 0 5px rgba(220, 38, 38, 0.2);
}

.check-item.unknown {
    border-left-color: var(--text-muted);
}

.check-name {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 4px;
    color: var(--text-main);
}

.check-status {
    font-size: 12px;
    color: var(--text-muted);
}

.check-error {
    font-size: 12px;
    color: #FCA5A5;
    margin-top: 4px;
}

.loading {
    text-align: center;
    padding: 40px;
    color: var(--text-muted);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
}

.loading[style*="display: none"] {
    display: none !important;
}

.loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    box-shadow: 0 0 10px rgba(220, 38, 38, 0.5);
}

.loading[style*="display: none"] .loading-spinner {
    animation: none;
}

#initial-loading {
    display: none !important;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.error-message {
    background: var(--error-light);
    color: #FCA5A5;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 20px;
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.success-message {
    background: var(--success-light);
    color: #6EE7B7;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 20px;
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.warming-status-card {
    background: var(--bg-card);
    border-radius: 8px;
    padding: 16px 20px;
    margin-bottom: 20px;
    box-shadow: var(--shadow);
    border-left: 4px solid var(--warning);
    border: 1px solid var(--border);
}

.warming-status-card h4 {
    margin: 0 0 8px 0;
    font-size: 14px;
    color: var(--text-main);
}

.warming-status-card .schedule {
    font-size: 13px;
    color: var(--text-muted);
    margin-bottom: 8px;
}

.warming-status-card .accounts-enabled {
    font-size: 12px;
    color: var(--text-muted);
}

.health-summary {
    margin-bottom: 20px;
    padding: 16px 20px;
    border-radius: 8px;
    border-left: 4px solid var(--warning);
    background: rgba(245, 158, 11, 0.1);
    color: #FCD34D;
    border: 1px solid rgba(245, 158, 11, 0.3);
}

.health-summary.critical {
    border-left-color: var(--primary);
    background: var(--error-light);
    color: #FCA5A5;
    border-color: rgba(239, 68, 68, 0.3);
    box-shadow: 0 0 15px rgba(220, 38, 38, 0.2);
}

.health-summary h4 {
    margin: 0 0 8px 0;
    font-size: 14px;
}

.health-summary ul {
    margin: 0;
    padding-left: 20px;
    font-size: 13px;
}

.account-card .issues-block {
    margin-bottom: 12px;
    padding: 12px;
    border-radius: 6px;
    background: var(--error-light);
    border-left: 3px solid var(--primary);
    font-size: 13px;
    color: #FCA5A5;
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.account-card .issues-block h4 {
    margin: 0 0 8px 0;
    font-size: 13px;
}

.account-card .issues-block ul {
    margin: 0;
    padding-left: 18px;
}
</style>

<script>
let refreshInterval = null;

const STATUS_FETCH_TIMEOUT_MS = 60000; // 60 seconds

function escapeHtml(str) {
    if (str == null) return '';
    const s = String(str);
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
}

async function loadAccountStatus(showLoading = true) {
    const container = document.getElementById('accounts-list');
    const initialLoading = document.getElementById('initial-loading');
    
    // Remove initial loading immediately to stop animation
    if (initialLoading) {
        initialLoading.remove(); // Remove from DOM to stop animation
    }
    
    if (showLoading) {
        container.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading account status...</div>';
    }
    
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), STATUS_FETCH_TIMEOUT_MS);
    
    try {
        const response = await fetch('/api/accounts/status', {
            credentials: 'include',
            signal: controller.signal,
        });
        clearTimeout(timeoutId);
        
        const data = await response.json().catch(() => ({}));
        
        if (!response.ok) {
            const msg = (typeof data.detail === 'string' ? data.detail : data.detail?.message) || response.statusText;
            if (response.status === 401) {
                container.innerHTML = '<div class="error-message">Please log in to view account status. <a href="/login">Log in</a></div>';
            } else {
                container.innerHTML = '<div class="error-message">Failed to load account status: ' + (msg || response.status) + '</div>';
            }
            return;
        }
        
        if (data.status === 'success' && Array.isArray(data.accounts)) {
            renderHealthSummary(data.accounts);
            renderAccounts(data.accounts);
            loadWarmingStatus();
        } else {
            container.innerHTML = '<div class="error-message">Failed to load account status</div>';
        }
    } catch (error) {
        clearTimeout(timeoutId);
        console.error('Error loading account status:', error);
        if (error.name === 'AbortError') {
            container.innerHTML = '<div class="error-message">Request timed out. Check your connection and try again.</div>';
        } else {
            container.innerHTML = '<div class="error-message">Error loading account status: ' + (error.message || 'Unknown error') + '</div>';
        }
    }
}

async function loadWarmingStatus() {
    const el = document.getElementById('warming-status');
    if (!el) return;
    try {
        const response = await fetch('/api/warming/status', { credentials: 'include' });
        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
            el.style.display = 'none';
            return;
        }
        const scheduleTime = data.schedule_time || '09:00';
        const accounts = data.accounts || [];
        const enabled = accounts.filter(a => a.enabled);
        el.innerHTML = '<h4>üî• Warming</h4>' +
            '<div class="schedule">Scheduled daily at ' + scheduleTime + '</div>' +
            '<div class="accounts-enabled">' + (enabled.length ? enabled.map(a => a.username || a.account_id).join(', ') + ' have warming enabled' : 'No accounts with warming enabled') + '</div>';
        el.style.display = 'block';
    } catch (_) {
        el.style.display = 'none';
    }
}

function getFailedChecks(account) {
    const checks = account.checks || {};
    return Object.entries(checks)
        .filter(([, c]) => (c && c.status === 'failed'))
        .map(([name, c]) => ({ name, error: c && c.error }));
}

function renderHealthSummary(accounts) {
    const el = document.getElementById('health-summary');
    if (!el) return;
    const withIssues = accounts.filter(a => {
        const s = (a.status || '').toLowerCase();
        return s === 'critical' || s === 'warning' || getFailedChecks(a).length > 0;
    });
    if (withIssues.length === 0) {
        el.style.display = 'none';
        el.innerHTML = '';
        return;
    }
    const hasCritical = withIssues.some(a => (a.status || '').toLowerCase() === 'critical');
    el.className = 'health-summary' + (hasCritical ? ' critical' : '');
    el.innerHTML = '<h4>' + (hasCritical ? '‚ö†Ô∏è Some accounts have critical issues' : '‚ö†Ô∏è Some accounts have issues') + '</h4>' +
        '<ul><li>' + withIssues.map(a => escapeHtml(a.username || a.account_id) + ' ‚Äì ' + (a.status || 'issues')).join('</li><li>') + '</li></ul>' +
        '<span style="font-size: 12px;">See each card below for details.</span>';
    el.style.display = 'block';
}

function renderAccounts(accounts) {
    const container = document.getElementById('accounts-list');
    const initialLoading = document.getElementById('initial-loading');
    
    // Ensure initial loading is removed
    if (initialLoading) {
        initialLoading.remove(); // Remove from DOM to stop animation
    }
    
    if (accounts.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No accounts configured</div>';
        return;
    }
    
    container.innerHTML = accounts.map(account => {
        const statusClass = (account.status || 'unknown').toLowerCase();
        const checks = account.checks || {};
        const failedChecks = getFailedChecks(account);
        
        const checksHtml = Object.entries(checks).map(([name, check]) => {
            const checkStatus = check.status || 'unknown';
            const checkClass = checkStatus === 'ok' ? 'ok' : (checkStatus === 'failed' ? 'failed' : 'unknown');
            const errorHtml = check.error ? '<div class="check-error">' + escapeHtml(check.error) + '</div>' : '';
            const label = name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            return `
                <div class="check-item ${checkClass}">
                    <div class="check-name">${escapeHtml(label)}</div>
                    <div class="check-status">${checkStatus === 'ok' ? '‚úì OK' : (checkStatus === 'failed' ? '‚úó Failed' : '? Unknown')}</div>
                    ${errorHtml}
                </div>
            `;
        }).join('');
        
        const issuesBlock = failedChecks.length > 0
            ? '<div class="issues-block"><h4>Issues</h4><ul>' +
              failedChecks.map(f => '<li><strong>' + escapeHtml(f.name.replace(/_/g, ' ')) + ':</strong> ' + escapeHtml(f.error || 'Failed') + '</li>').join('') +
              '</ul></div>'
            : '';
        
        return `
            <div class="account-card ${statusClass}">
                <div class="account-header">
                    <div class="account-info">
                        <h3>${escapeHtml(account.username || 'Unknown')}</h3>
                        <div class="account-id">${escapeHtml(account.account_id)}</div>
                    </div>
                    <span class="status-badge ${statusClass}">${escapeHtml(account.status || 'unknown')}</span>
                </div>
                ${issuesBlock}
                <div class="checks-grid">
                    ${checksHtml}
                </div>
                <div style="margin-top: 12px; font-size: 12px; color: #6b7280;">
                    Last checked: ${account.timestamp ? new Date(account.timestamp).toLocaleString() : '‚Äî'}
                </div>
            </div>
        `;
    }).join('');
}

document.getElementById('refresh-status').addEventListener('click', () => {
    loadAccountStatus();
});

document.getElementById('connect-account').addEventListener('click', openConnectAccountModal);

function openConnectAccountModal() {
    const modal = document.getElementById('connect-account-modal');
    modal.style.display = 'flex';
    modal.classList.remove('hidden');
    document.getElementById('connect-account-form').reset();
    document.getElementById('conn-acc-warming').checked = true;
    document.getElementById('conn-acc-dm-enabled').checked = false;
    document.getElementById('conn-acc-ai-dm-enabled').checked = true;
}

function closeConnectAccountModal() {
    const modal = document.getElementById('connect-account-modal');
    modal.style.display = 'none';
    modal.classList.add('hidden');
}

async function saveConnectAccount() {
    const accountId = document.getElementById('conn-acc-id').value.trim();
    const username = document.getElementById('conn-acc-username').value.trim();
    const token = document.getElementById('conn-acc-token').value.trim();
    const password = document.getElementById('conn-acc-password').value.trim();
    const warming = document.getElementById('conn-acc-warming').checked;
    const dmEnabled = document.getElementById('conn-acc-dm-enabled').checked;
    const dmLink = document.getElementById('conn-acc-dm-link').value.trim();
    const aiDmEnabled = document.getElementById('conn-acc-ai-dm-enabled').checked;

    if (!accountId || !username || !token) {
        alert('Please fill in Account ID, Username, and Access Token.');
        return;
    }

    const accountData = {
        account_id: accountId,
        username: username,
        access_token: token,
        warming: {
            enabled: warming,
            daily_actions: 10,
            action_types: ['like', 'comment']
        },
        proxy: { enabled: false },
        comment_to_dm: {
            enabled: dmEnabled,
            link_to_send: dmLink || null
        },
        ai_dm: { enabled: aiDmEnabled, auto_send: true }
    };
    if (password) accountData.password = password;

    try {
        const response = await fetch('/api/config/accounts/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(accountData),
            credentials: 'include'
        });

        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
            const msg = typeof data.detail === 'string' ? data.detail : (data.detail?.message || JSON.stringify(data.detail));
            throw new Error(msg || 'Failed to add account');
        }

        closeConnectAccountModal();
        const container = document.getElementById('accounts-list');
        container.innerHTML = '<div class="success-message">Account connected successfully. Refreshing...</div>';
        setTimeout(() => loadAccountStatus(), 1000);
    } catch (error) {
        alert('Error: ' + (error.message || 'Failed to connect account'));
    }
}

document.getElementById('run-warming').addEventListener('click', async () => {
    const button = document.getElementById('run-warming');
    button.disabled = true;
    const origHtml = button.innerHTML;
    button.innerHTML = '<span class="icon">‚è≥</span> Running...';
    try {
        const response = await fetch('/api/warming/run', { method: 'POST', credentials: 'include' });
        const data = await response.json().catch(() => ({}));
        if (response.ok && data.message) {
            alert('Warming: ' + data.message);
        } else {
            alert('Warming failed: ' + (data.detail || response.statusText || 'Unknown error'));
        }
    } catch (e) {
        alert('Warming failed: ' + (e.message || 'Network error'));
    } finally {
        button.disabled = false;
        button.innerHTML = origHtml;
    }
});

document.getElementById('reload-accounts').addEventListener('click', async () => {
    const button = document.getElementById('reload-accounts');
    button.disabled = true;
    button.textContent = 'Reloading...';
    
    try {
        const response = await fetch('/api/accounts/reload', { method: 'POST', credentials: 'include' });
        const data = await response.json().catch(() => ({}));
        
        if (response.ok && data.status === 'success') {
            const container = document.getElementById('accounts-list');
            container.innerHTML = '<div class="success-message">Accounts reloaded successfully. Refreshing status...</div>';
            setTimeout(() => loadAccountStatus(), 1000);
        } else {
            alert('Failed to reload accounts: ' + (data.detail || response.statusText || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error reloading accounts:', error);
        alert('Error reloading accounts: ' + error.message);
    } finally {
        button.disabled = false;
        button.innerHTML = '<span class="icon">‚ôªÔ∏è</span> Reload Accounts';
    }
});

// Remove initial loading immediately on page load to stop animation
document.addEventListener('DOMContentLoaded', () => {
    const initialLoading = document.getElementById('initial-loading');
    if (initialLoading) {
        initialLoading.remove();
    }
});

// Load on page load
loadAccountStatus();

// Auto-refresh every 60 seconds (don't show loading spinner on auto-refresh)
refreshInterval = setInterval(() => loadAccountStatus(false), 60000);

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>
{% endblock %}
