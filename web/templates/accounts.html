{% extends "layout.html" %}

{% block title %}Account Status - InstaForge{% endblock %}

{% block page_title %}Account Status{% endblock %}

{% block content %}
<div class="accounts-status-page">
    <div class="page-header">
        <div class="header-actions">
            <button id="refresh-status" class="btn btn-primary">
                <span class="icon">üîÑ</span> Refresh Status
            </button>
            <button id="reload-accounts" class="btn btn-secondary">
                <span class="icon">‚ôªÔ∏è</span> Reload Accounts
            </button>
            <button id="run-warming" class="btn btn-secondary" title="Run warming actions now for all accounts with warming enabled">
                <span class="icon">üî•</span> Run Warming Now
            </button>
        </div>
    </div>

    <div id="warming-status" class="warming-status-card" style="display: none;"></div>

    <div id="health-summary" class="health-summary" style="display: none;"></div>

    <div id="accounts-list" class="accounts-list">
        <div class="loading"><div class="loading-spinner"></div>Loading account status...</div>
    </div>
</div>

<style>
.accounts-status-page {
    padding: 20px;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.header-actions {
    display: flex;
    gap: 12px;
}

.accounts-list {
    display: grid;
    gap: 20px;
}

.account-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-left: 4px solid #ccc;
}

.account-card.healthy {
    border-left-color: #10b981;
}

.account-card.warning {
    border-left-color: #f59e0b;
}

.account-card.critical {
    border-left-color: #ef4444;
}

.account-card.unknown {
    border-left-color: #6b7280;
}

.account-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.account-info h3 {
    margin: 0 0 4px 0;
    font-size: 18px;
    font-weight: 600;
}

.account-info .account-id {
    color: #6b7280;
    font-size: 14px;
}

.status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-badge.healthy {
    background: #d1fae5;
    color: #065f46;
}

.status-badge.warning {
    background: #fef3c7;
    color: #92400e;
}

.status-badge.critical {
    background: #fee2e2;
    color: #991b1b;
}

.status-badge.unknown {
    background: #f3f4f6;
    color: #374151;
}

.checks-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    margin-top: 16px;
}

.check-item {
    padding: 12px;
    background: #f9fafb;
    border-radius: 6px;
    border-left: 3px solid #ccc;
}

.check-item.ok {
    border-left-color: #10b981;
}

.check-item.failed {
    border-left-color: #ef4444;
}

.check-item.unknown {
    border-left-color: #6b7280;
}

.check-name {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 4px;
}

.check-status {
    font-size: 12px;
    color: #6b7280;
}

.check-error {
    font-size: 12px;
    color: #ef4444;
    margin-top: 4px;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #6b7280;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
}

.loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid #e5e7eb;
    border-top-color: #6366f1;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.error-message {
    background: #fee2e2;
    color: #991b1b;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 20px;
}

.success-message {
    background: #d1fae5;
    color: #065f46;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 20px;
}

.warming-status-card {
    background: white;
    border-radius: 8px;
    padding: 16px 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-left: 4px solid #f59e0b;
}

.warming-status-card h4 {
    margin: 0 0 8px 0;
    font-size: 14px;
    color: #374151;
}

.warming-status-card .schedule {
    font-size: 13px;
    color: #6b7280;
    margin-bottom: 8px;
}

.warming-status-card .accounts-enabled {
    font-size: 12px;
    color: #6b7280;
}

.health-summary {
    margin-bottom: 20px;
    padding: 16px 20px;
    border-radius: 8px;
    border-left: 4px solid #f59e0b;
    background: #fffbeb;
    color: #92400e;
}

.health-summary.critical {
    border-left-color: #ef4444;
    background: #fef2f2;
    color: #991b1b;
}

.health-summary h4 {
    margin: 0 0 8px 0;
    font-size: 14px;
}

.health-summary ul {
    margin: 0;
    padding-left: 20px;
    font-size: 13px;
}

.account-card .issues-block {
    margin-bottom: 12px;
    padding: 12px;
    border-radius: 6px;
    background: #fef2f2;
    border-left: 3px solid #ef4444;
    font-size: 13px;
    color: #991b1b;
}

.account-card .issues-block h4 {
    margin: 0 0 8px 0;
    font-size: 13px;
}

.account-card .issues-block ul {
    margin: 0;
    padding-left: 18px;
}
</style>

<script>
let refreshInterval = null;

const STATUS_FETCH_TIMEOUT_MS = 60000; // 60 seconds

function escapeHtml(str) {
    if (str == null) return '';
    const s = String(str);
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
}

async function loadAccountStatus() {
    const container = document.getElementById('accounts-list');
    container.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading account status...</div>';
    
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), STATUS_FETCH_TIMEOUT_MS);
    
    try {
        const response = await fetch('/api/accounts/status', {
            credentials: 'include',
            signal: controller.signal,
        });
        clearTimeout(timeoutId);
        
        const data = await response.json().catch(() => ({}));
        
        if (!response.ok) {
            const msg = (typeof data.detail === 'string' ? data.detail : data.detail?.message) || response.statusText;
            if (response.status === 401) {
                container.innerHTML = '<div class="error-message">Please log in to view account status. <a href="/login">Log in</a></div>';
            } else {
                container.innerHTML = '<div class="error-message">Failed to load account status: ' + (msg || response.status) + '</div>';
            }
            return;
        }
        
        if (data.status === 'success' && Array.isArray(data.accounts)) {
            renderHealthSummary(data.accounts);
            renderAccounts(data.accounts);
            loadWarmingStatus();
        } else {
            container.innerHTML = '<div class="error-message">Failed to load account status</div>';
        }
    } catch (error) {
        clearTimeout(timeoutId);
        console.error('Error loading account status:', error);
        if (error.name === 'AbortError') {
            container.innerHTML = '<div class="error-message">Request timed out. Check your connection and try again.</div>';
        } else {
            container.innerHTML = '<div class="error-message">Error loading account status: ' + (error.message || 'Unknown error') + '</div>';
        }
    }
}

async function loadWarmingStatus() {
    const el = document.getElementById('warming-status');
    if (!el) return;
    try {
        const response = await fetch('/api/warming/status', { credentials: 'include' });
        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
            el.style.display = 'none';
            return;
        }
        const scheduleTime = data.schedule_time || '09:00';
        const accounts = data.accounts || [];
        const enabled = accounts.filter(a => a.enabled);
        el.innerHTML = '<h4>üî• Warming</h4>' +
            '<div class="schedule">Scheduled daily at ' + scheduleTime + '</div>' +
            '<div class="accounts-enabled">' + (enabled.length ? enabled.map(a => a.username || a.account_id).join(', ') + ' have warming enabled' : 'No accounts with warming enabled') + '</div>';
        el.style.display = 'block';
    } catch (_) {
        el.style.display = 'none';
    }
}

function getFailedChecks(account) {
    const checks = account.checks || {};
    return Object.entries(checks)
        .filter(([, c]) => (c && c.status === 'failed'))
        .map(([name, c]) => ({ name, error: c && c.error }));
}

function renderHealthSummary(accounts) {
    const el = document.getElementById('health-summary');
    if (!el) return;
    const withIssues = accounts.filter(a => {
        const s = (a.status || '').toLowerCase();
        return s === 'critical' || s === 'warning' || getFailedChecks(a).length > 0;
    });
    if (withIssues.length === 0) {
        el.style.display = 'none';
        el.innerHTML = '';
        return;
    }
    const hasCritical = withIssues.some(a => (a.status || '').toLowerCase() === 'critical');
    el.className = 'health-summary' + (hasCritical ? ' critical' : '');
    el.innerHTML = '<h4>' + (hasCritical ? '‚ö†Ô∏è Some accounts have critical issues' : '‚ö†Ô∏è Some accounts have issues') + '</h4>' +
        '<ul><li>' + withIssues.map(a => escapeHtml(a.username || a.account_id) + ' ‚Äì ' + (a.status || 'issues')).join('</li><li>') + '</li></ul>' +
        '<span style="font-size: 12px;">See each card below for details.</span>';
    el.style.display = 'block';
}

function renderAccounts(accounts) {
    const container = document.getElementById('accounts-list');
    
    if (accounts.length === 0) {
        container.innerHTML = '<div class="loading">No accounts configured</div>';
        return;
    }
    
    container.innerHTML = accounts.map(account => {
        const statusClass = (account.status || 'unknown').toLowerCase();
        const checks = account.checks || {};
        const failedChecks = getFailedChecks(account);
        
        const checksHtml = Object.entries(checks).map(([name, check]) => {
            const checkStatus = check.status || 'unknown';
            const checkClass = checkStatus === 'ok' ? 'ok' : (checkStatus === 'failed' ? 'failed' : 'unknown');
            const errorHtml = check.error ? '<div class="check-error">' + escapeHtml(check.error) + '</div>' : '';
            const label = name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            return `
                <div class="check-item ${checkClass}">
                    <div class="check-name">${escapeHtml(label)}</div>
                    <div class="check-status">${checkStatus === 'ok' ? '‚úì OK' : (checkStatus === 'failed' ? '‚úó Failed' : '? Unknown')}</div>
                    ${errorHtml}
                </div>
            `;
        }).join('');
        
        const issuesBlock = failedChecks.length > 0
            ? '<div class="issues-block"><h4>Issues</h4><ul>' +
              failedChecks.map(f => '<li><strong>' + escapeHtml(f.name.replace(/_/g, ' ')) + ':</strong> ' + escapeHtml(f.error || 'Failed') + '</li>').join('') +
              '</ul></div>'
            : '';
        
        return `
            <div class="account-card ${statusClass}">
                <div class="account-header">
                    <div class="account-info">
                        <h3>${escapeHtml(account.username || 'Unknown')}</h3>
                        <div class="account-id">${escapeHtml(account.account_id)}</div>
                    </div>
                    <span class="status-badge ${statusClass}">${escapeHtml(account.status || 'unknown')}</span>
                </div>
                ${issuesBlock}
                <div class="checks-grid">
                    ${checksHtml}
                </div>
                <div style="margin-top: 12px; font-size: 12px; color: #6b7280;">
                    Last checked: ${account.timestamp ? new Date(account.timestamp).toLocaleString() : '‚Äî'}
                </div>
            </div>
        `;
    }).join('');
}

document.getElementById('refresh-status').addEventListener('click', () => {
    loadAccountStatus();
});

document.getElementById('run-warming').addEventListener('click', async () => {
    const button = document.getElementById('run-warming');
    button.disabled = true;
    const origHtml = button.innerHTML;
    button.innerHTML = '<span class="icon">‚è≥</span> Running...';
    try {
        const response = await fetch('/api/warming/run', { method: 'POST', credentials: 'include' });
        const data = await response.json().catch(() => ({}));
        if (response.ok && data.message) {
            alert('Warming: ' + data.message);
        } else {
            alert('Warming failed: ' + (data.detail || response.statusText || 'Unknown error'));
        }
    } catch (e) {
        alert('Warming failed: ' + (e.message || 'Network error'));
    } finally {
        button.disabled = false;
        button.innerHTML = origHtml;
    }
});

document.getElementById('reload-accounts').addEventListener('click', async () => {
    const button = document.getElementById('reload-accounts');
    button.disabled = true;
    button.textContent = 'Reloading...';
    
    try {
        const response = await fetch('/api/accounts/reload', { method: 'POST', credentials: 'include' });
        const data = await response.json().catch(() => ({}));
        
        if (response.ok && data.status === 'success') {
            const container = document.getElementById('accounts-list');
            container.innerHTML = '<div class="success-message">Accounts reloaded successfully. Refreshing status...</div>';
            setTimeout(() => loadAccountStatus(), 1000);
        } else {
            alert('Failed to reload accounts: ' + (data.detail || response.statusText || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error reloading accounts:', error);
        alert('Error reloading accounts: ' + error.message);
    } finally {
        button.disabled = false;
        button.innerHTML = '<span class="icon">‚ôªÔ∏è</span> Reload Accounts';
    }
});

// Load on page load
loadAccountStatus();

// Auto-refresh every 60 seconds
refreshInterval = setInterval(loadAccountStatus, 60000);

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>
{% endblock %}
