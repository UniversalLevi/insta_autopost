# Apache config for veilforce.com / InstaForge
# Copy to /etc/apache2/sites-available/ and enable:
#   sudo cp deploy/apache-veilforce.conf /etc/apache2/sites-available/veilforce.conf
#   sudo a2enmod proxy proxy_http headers
#   sudo a2ensite veilforce
#   sudo systemctl reload apache2

# CRITICAL for Instagram media URLs:
# - Proxy /uploads/ to FastAPI (byte-range, CORS, correct MIME types)
# - Do NOT block facebookexternalhit, Facebot (Instagram's crawler)
# - Increase ProxyTimeout for large video files

<VirtualHost *:443>
    ServerName veilforce.com
    ServerAlias www.veilforce.com

    # SSL (use certbot/Let's Encrypt)
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/veilforce.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/veilforce.com/privkey.pem

    # Proxy everything to InstaForge (FastAPI)
    ProxyPreserveHost On
    ProxyPass / http://127.0.0.1:8000/
    ProxyPassReverse / http://127.0.0.1:8000/

    # Timeout for large video uploads (Instagram fetches MP4; can be slow)
    ProxyTimeout 300

    # Ensure Instagram/Facebook crawlers are NOT blocked (no SetEnvIf blocking)
    # The app serves /uploads/ without auth; proxy passes Range headers for MP4 streaming

    # Pass through required headers for the app
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
</VirtualHost>
